# Split Plot Design

Split-plot design is frequently used for factorial experiments. Such design may incorporate one or more of the completely randomized (CRD), completely randomized block (RCBD), and Latin square designs. The main principle is that there are whole plots or whole units, to which the levels of one or more factors are applied. Thus each whole plot becomes a block for the subplot treatments.

## Details for Split Plot Designs

1.  Whole Plot Randomized as a completely randomized design

The statistical model structure this design:

$$y_{ijk} = \mu + \alpha_i + \beta_k + (\alpha_j\beta_k) + \epsilon_{ij} + \delta_{ijk} $$ Where:

$\mu$= overall experimental mean, $\alpha$ = main effect of whole plot (fixed), $\beta$ = main effect of subplot (fixed), $\alpha$$\tau$ = interaction between factors A and B, $\epsilon_{ij}$ = whole plot error, $\delta_{ijk}$ = subplot error.

$$ \epsilon \sim N(0, \sigma_\epsilon)$$

$$\ \delta  \sim N(0, \sigma_\delta)$$

Both the error and the rep effects are assumed to be normally distributed with a mean of zero and standard deviations of $\sigma_\epsilon$ and $\sigma_\delta$, respectively.

2.  Whole Plot Randomized as an RCBD

This is also referred as "Split-Block RCB" design. The statistical model structure for split plot design:

$$y_{ijk} = \mu + \rho_j +  \alpha_i + \beta_k + (\alpha_i\beta_k) + \epsilon_{ij} + \delta_{ijk}$$ Where:

$\mu$ = overall experimental mean, $\rho$ = block effect (random), $\alpha$ = main effect of whole plot (fixed), $\beta$ = main effect of subplot (fixed), $\alpha$$\beta$ = interaction between factors A and B, $\epsilon_{ij}$ = whole plot error, $\delta_{ijk}$ = subplot error.

$$ \epsilon \sim N(0, \sigma_\epsilon)$$

$$\ \delta  \sim N(0, \sigma_\delta)$$

Both the overall error and the rep effects are assumed to be normally distributed with a mean of zero and standard deviations of $\sigma$ and $\sigma_\delta$, respectively.

#### 'iid' assumption for error terms

In these model, the error terms, $\epsilon$ are assumed to be "iid", that is, independently and identically distributed. This means they have constant variance and they each individual error term is independent from the others.

![Split Plot CRD Design](images/split_plot_CRD-01.jpeg){fig-align="center" width="341"}

![Split Plot RCBD Design](images/Split_plot_RCBD.jpeg){fig-align="center" width="348"}

## Analysis Examples

### Example model for CRD Split Plot Designs

1.  Load required libraries

```{r}
#| message: false
#| warning: false
library(dplyr)
library(ggplot2)
library(emmeans)
library(lme4)
library(nlme)
library(broom.mixed)
library(multcomp)
library(multcompView)
library(performance)
```

2.  Import height data and check the structure of the data.

The data (Height data) for this example involves a CRD split plot designed experiment. Treatments are 4 Timings (times) and 8 managements (manage). The whole plots are times and management represents subplot and 3 replications.

```{r}
height_data <- readxl::read_excel(here::here("data", "height_data.xlsx"))

```

3.  Data integrity checks

-   Run a cross tabulation using `table()` to check the arrangement of whole-plots and sub-plots.

```{r}
table(height_data$time, height_data$manage)
```

-   Look at structure of the data using `str()`, this will help in identifying class of the variable. In this dataset, class of the whole-plot, sub-plot, and block should be factor/character and response variable (height) should be numeric.

```{r}
str(height_data)
```

-   Check the number of missing values in each column.

```{r}
apply(height_data, 2, function(x) sum(is.na(x)))
```

-   Exploratory boxplot to look at the height observations at different times with variable managements.

```{r}
ggplot(data = height_data, aes(y = height, x = time)) +
  geom_boxplot(aes(colour = manage))
```

4.  Specify a model for data

::: column-margin
Recall the model:

$$y_{ijk} = \mu + \gamma_i +  \alpha_j + \beta_k + (\alpha_j\beta_k) + \epsilon_{ijk}$$

For this model, $\gamma$ = block/rep effect (random), $\alpha$ = main effect of whole plot (fixed), $\beta$ = main effect of subplot (fixed), $\alpha$$\beta$ = interaction between factors A and B (fixed).
:::

In order to test the main effects of the treatments as well as the interaction between two factors, we can specify that in model as: `time + manage + time:manage` or `time*manage`.

When dealing with split plot design across reps or blocks, the random effects needs to be nested hierarchically, from largest unit to smallest. For example, in this example the random effects will be designated as `(1 | rep/time)`. This implies that random intercepts vary with rep and time within rep.

::: panel-tabset
### lme4

```{r}
model1<-lmer(height ~ time*manage + (1|rep/time), data=height_data)

summary(model1)
model1 %>% glance()
```

### nlme

```{r}
model2 <-lme(height ~ time*manage,
             random=~ 1|rep/time, data=height_data)

summary(model1)

```
:::

### Check Model Assumptions

Before interpreting the model we should investigate the assumptions of the model to ensure any conclusions we draw are valid. There are assumptions that we can check are 1. Homogeneity (equal variance) 2. normality of residuals 3. values with high leverage.

We can evaluate the assumptions in two ways: 1. By plotting model using `plot()` and residuals using `qqnorm()`.

```{r, eval=FALSE}
plot(model1, resid(., scaled=TRUE) ~ fitted(.), 
     xlab = "fitted values", ylab = "studentized residuals")
```

```{r, echo=FALSE}
#| label: fig-rcbd_error
#| fig-cap: "Plot of residuals versus fitted values"
#| column: margin
#| 
par(mar=c(5.1, 5, 2.1, 2.1))
plot(model1, resid(., scaled=TRUE) ~ fitted(.), 
     xlab = "fitted values", ylab = "studentized residuals",
     cex.lab = 1.8, cex.axis = 1.5)
```

We are looking for a random and uniform distribution of points. This looks good!

::: column-margin
The same code works for nlme and lme4-generated models.
:::

Checking normality requiring first extracting the model residuals with `resid()` and then generaing a qq-plot and line.

```{r, eval=FALSE}
qqnorm(resid(model1), main = NULL); qqline(resid(model1))
```

```{r, echo=FALSE}
#| label: fig-rcbd_norm
#| fig-cap: "QQ-plot of residuals"
#| column: margin

par(mar=c(5.1, 5, 2.1, 2.1))
qqnorm(resid(model1), main = NULL, cex.lab = 1.8, cex.axis = 1.5); qqline(resid(model1))
```

Or we can use `check_model()` function from 'performance' package. The plots generated using this code gives a visual check of various assumptions including normality of residuals, normality of random effects, heteroscedasticity, homogeneity of variance, and multicollinearity.

```{r, fig.height=9}
# checking model assumptions
check_model(model1)
```

In this case the residuals fit the assumptions of the model well.

### Interpretation of the model:

The `anova()` function prints the the rows of analysis of variance table for whole-plot, sub-plot, and their interactions.

```{r}
anova(model1)
```

The estimated marginal means for each fixed effect and interaction effect can be obtained using `emmeans()`.

```{r}
m1 <- emmeans(model1, ~ time)
emmeans(model1, ~ manage)
emmeans(model1, ~ time*manage)
```

Further, a pairwise comparison or contrasts can be analyzed using estimated means.

For example, if we want to compare difference in height at different time periods, this could be done using `pairs()` command from emmeans package.

```{r}
pairs(m1)
```

The letters indicating signficant differences can be generated using

```{r}
multcomp::cld(m1, Letters= TRUE)
```

### Example model for RCBD Split Plot Designs

Design Summary:

Main plot = Variety (V), 3 levels

Subplot = Nitrogen (N), 4 levels

Number of blocks (B) = 6

Dependent variable = yield (Y)

To fully examine the yield of oats due to varieties and nutrient levels in a split plots. We will need to statistically analyse and compare the effects of varieties, nutrient levels, their interaction, and the effects of plots and subplots.

**Load the data:**

```{r}
library(MASS)
data("oats")
head(oats,10)
```

Evaluate the structure of the data. The "B", "V", and "N" needs to be 'factor' and "Y" should be numeric.

```{r}
str(oats)
```

```{r}
table(oats$V, oats$N)
```

**Building the Model**

```{r}
model2 <- lmer(Y ~ V + N + V:N + (1|B) + (1|B:V), data = oats)
summary(model2)
## use broom.mixed here instead of summary
```

**Assumption tests**

Normality of residuals and homogenous variance

```{r}
# checking model assumptions
check_model(model2)
```

**Analysis of Variance** (ANOVA)

```{r}
anova(model2)
```

Post-Hoc analysis

```{r}
emm <- emmeans(model2, ~ V *N) 
omparison <- cld(emm, Letters = LETTERS, reversed = T)
```

::: callout-note
## `na.action = na.exclude`

The RCBD split-plot design is also commonly called split-block Design or the strip-plot Design
:::

## Split-split plot design in R

In this example, we have a yield data of 3 different rice varieties grown under 3 management practices and 5 Nitrogen levels. In this split-split design:

blocks = block (3 blocks),

Whole plot factor = Nitrogen (5 levels)

Sub plot = management (3 levels)

sub-subplot = variety (3 levels)

Statistical model:

**add model equation here**

Here, we are extracting the rice yield data from `agricolae` package.

```{r}
library(agricolae)
f <- system.file("external/ssp.csv", package="agricolae")
rice <-read.csv(f)
```

Exploratory analysis

```{r}
str(rice)
```

Convert block, nitrogen, variety, and management to factors.

```{r}
rice$block<-factor(rice$block)
rice$nitrogen<-factor(rice$nitrogen)
rice$management<-factor(rice$management)
rice$variety<-factor(rice$variety)
```

Statistical model:

Here is the basic split-split plot analysis. We can use the nesting notation in the random part because nitrogen and management are nested in blocks. We can do blocks as fixed or random.

```{r}
model3 <-lmer(yield ~  block + nitrogen*management*variety + (1|block/nitrogen/management),data=rice, na.action = na.exclude)

summary(model3)

```

Model Diagnostics: we observed a constant variance and normality of residuals.

```{r}

plot(model3)
qqnorm(residuals(model3)); qqline(residuals(model3))

library(see)
check_model(model3)
```

Analysis of variance

```{r}
anova(model3)
```

Post-Hoc analysis

```{r}
emmeans(model3, ~ nitrogen)
emmeans(model3, ~ variety*management)
```

```{r}
emm <- emmeans(model3, ~ nitrogen*variety) 
comparison <- cld(emm, Letters = LETTERS, reversed = T) 
comparison
```
